<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Sensors</title>
    <script src="https://unpkg.com/d3@5.9.2/dist/d3.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/metrics-graphics@2.15.6/dist/metricsgraphics.css"/>
    <script src="https://unpkg.com/metrics-graphics@2.15.6/dist/metricsgraphics.min.js"></script>
  </head>
  <body>
    <p>
      This method uses Sensors API to schedule the background execution.
    </p>
    <div id="chart"/>

    <script src="functions.js"></script>
    <script>
      let cb = null;
      if ("AmbientLightSensor" in window) {
        let sensor = new AmbientLightSensor({frequency: 10});
        sensor.onerror = function (error) {
          console.error(error);
        };
        sensor.onreading = function (event) {
          console.log('illuminance', event.target.illuminance);
          if (cb) cb();
        };
        sensor.start();
      }
      window.ondevicelight = function (event) {
        console.log('devicelight', event);
        if (cb) cb();
      };
      window.ondevicemotion = function (event) {
        console.log('devicemotion', event);
        if (cb) cb();
      };

      measure("sensor", function(callback) {
        console.log('start');
        cb = callback;
        return function () {
          cb = null;
          console.log('stop')
        };
      }, function(dataPoints) {
        const keys = Object.keys(dataPoints).sort();
        const firstSecond = keys[0];
        const data = keys.map(key => ({
          key: (parseInt(key) - parseInt(firstSecond)) / 1000,
          value: dataPoints[key],
        }));
        MG.data_graphic({
          title: "Ticks per second",
          data: data,
          width: 600,
          height: 200,
          target: document.getElementById('chart'),
          x_accessor: 'key',
          x_label: 'Seconds since start',
          y_accessor: 'value',
          y_label: 'Ticks per second',
        });
      });
    </script>
  </body>
</html>
